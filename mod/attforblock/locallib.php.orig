<?php
global $CFG;
require_once($CFG->libdir.'/gradelib.php');

define('ONE_DAY', 86400);   // Seconds in one day
define('ONE_WEEK', 604800);   // Seconds in one week
define('UPDATE_DURATION', 7);   // time to update the attendance

//Function added by Saqib to calculate date diff
//August 10th, 2009
function dateDiff($dformat, $endDate, $beginDate)
{
           $date_parts1=explode($dformat, $beginDate);
           $date_parts2=explode($dformat, $endDate);
           $start_date=gregoriantojd($date_parts1[0], $date_parts1[1], $date_parts1[2]);
           $end_date=gregoriantojd($date_parts2[0], $date_parts2[1], $date_parts2[2]);
           return $end_date - $start_date;
}

//Added By Hina Yousuf
function get_lecture_sessions( $course,$endtime)
{
        global $CFG, $DB;
        $endtime =strtotime(date("Y-m-d", $endtime) . " +1 days");
	$sql="select count(*) from {attendance_sessions} where courseid=$course->id and lasttaken IS NOT NULL and description IN(1,4) and sessdate >=$course->startdate and sessdate<=$endtime";
        $sessions=$DB->count_records_sql($sql,array());
        return $sessions;

}

function get_lab_sessions( $course,$endtime)
{
        global $CFG, $DB;
	$endtime =strtotime(date("Y-m-d", $endtime) . " +1 days");
        $sql="select count(*) from {attendance_sessions} where courseid=$course->id and lasttaken IS NOT NULL and description IN(2,3) and sessdate >=$course->startdate and sessdate<=$endtime";
        $sessions=$DB->count_records_sql($sql,array());
        return $sessions;

}

//end


function show_tabs($cm, $context, $currenttab='sessions')
{
    $toprow = array();
    if (has_capability('mod/attforblock:manageattendances', $context) or
            has_capability('mod/attforblock:takeattendances', $context) or
            has_capability('mod/attforblock:changeattendances', $context)) {
        $toprow[] = new tabobject('sessions', 'manage.php?id='.$cm->id,
                    get_string('sessions','attforblock'));
    }

    if (has_capability('mod/attforblock:manageattendances', $context)) {
        $toprow[] = new tabobject('add', "sessions.php?id=$cm->id&amp;action=add",
                    get_string('add','attforblock'));
    }
    if (has_capability('mod/attforblock:viewreports', $context)) {
	    $toprow[] = new tabobject('report', 'report.php?id='.$cm->id,
	                get_string('report','attforblock'));
    }
    if (has_capability('mod/attforblock:export', $context)) {
	    $toprow[] = new tabobject('export', 'export.php?id='.$cm->id,
	                get_string('export','quiz'));
    }
    if (has_capability('mod/attforblock:disallowattendances', $context)) {
	    $toprow[] = new tabobject('settings', 'attsettings.php?id='.$cm->id,
                    get_string('settings','attforblock'));
    }



    $tabs = array($toprow);
    print_tabs($tabs, $currenttab);
}


//getting settings for course

function get_statuses($courseid, $onlyvisible = true)
{
	global $DB;
  	if ($onlyvisible) {
  		$result = $DB->get_records_select('attendance_statuses', "courseid = $courseid AND visible = 1 AND deleted = 0", array(), 'grade DESC');
  	} else {
  		$result = $DB->get_records_select('attendance_statuses', "courseid = $courseid AND deleted = 0", array(), 'grade DESC');  		
//  		$result = get_records('attendance_statuses', 'courseid', $courseid, 'grade DESC');
  	}
    return $result;
}	

//gets attendance status for a student, returns count

function get_attendance($userid, $course, $statusid=0)
{
	global $CFG;
	global $DB;
	$qry = "SELECT count(*) as cnt 
		  	  FROM {$CFG->prefix}attendance_log al 
			  JOIN {$CFG->prefix}attendance_sessions ats 
			    ON al.sessionid = ats.id
			 WHERE ats.courseid = $course->id 
			  	AND ats.sessdate >= $course->startdate
	         	AND al.studentid = $userid";
	if ($statusid) {
		$qry .= " AND al.statusid = $statusid";
	}
	
	return $DB->count_records_sql($qry);
}

function get_attendance_bydate($userid, $course, $statusid=0, $where='')
{
	global $CFG;
	global $DB;
/*	$qry = "SELECT count(*) as cnt
		  	  FROM {$CFG->prefix}attendance_log al
			  JOIN {$CFG->prefix}attendance_sessions s
			    ON al.sessionid = s.id
			 WHERE ".$where." ";
                                //ats.courseid = $course->id
			  	//AND ats.sessdate >= $course->startdate

	         	$qry .= " AND al.studentid = $userid";
	if ($statusid) {
		$qry .= " AND al.statusid = $statusid";
	}
        

	return $DB->count_records_sql($qry);*/

	$qry = "SELECT l.id, l.statusid, l.statusset, s.description
		  	  FROM {$CFG->prefix}attendance_log l
			  JOIN {$CFG->prefix}attendance_sessions s
			    ON l.sessionid = s.id
			 WHERE ".$where." ";
                                //ats.courseid = $course->id
			  	//AND ats.sessdate >= $course->startdate

	         	$qry .= " AND l.studentid = $userid";
	if ($statusid) {
		$qry .= " AND l.statusid = $statusid";
	}
	$logs=$DB->get_records_sql($qry);
	///
	$maxgrade = 0;
	if ($logs) {
		$stat_grades = $DB->get_records_menu('attendance_statuses', array('courseid'=>$course->id), 'id', 'id, grade');
		foreach ($logs as $log) {
			$ids = array_flip(explode(',', $log->statusset));
//			$grades = array_intersect_key($stat_grades, $ids); // require PHP 5.1.0 and higher
			$grades = local_array_intersect_key($stat_grades, $ids); //temporary solution, for support PHP 4.3.0 which minimal requirement for Moodle 1.9.x
                        if($log->description=="1")
                            $maxgrade += max($grades);
                        if($log->description=="2")
                            $maxgrade += max($grades);
                        if($log->description=="3")
                            $maxgrade += max($grades);
                        if($log->description=="4")
                            $maxgrade += 1.5;
			if($log->description=="5")
			$maxgrade += 2;
			if($log->description=="6")
			$maxgrade += 3;
			
		}
		if(isset($course->attendance_margin)){
			$margin = $course->attendance_margin;
			while($margin > 0){
				if($log->description=="1")
				$maxgrade += 1;
	            if($log->description=="2")
					$maxgrade += 1;
	            if($log->description=="3")
					$maxgrade += 1;
				if($log->description == "4")
					$maxgrade += 1.5;
		if($log->description=="5")
				$maxgrade += 2;
				if($log->description == "6")
				$maxgrade += 3;
				$margin--;
			}
		}
	}
	
	return $maxgrade;
}

function get_firstmonday($month,$year){

	$num = date("d",mktime(0,0,0,$month,date("d"),$year));
        //echo $num;
	if($num>5)
		return mktime(0,0,0,$month,1,$year);
	else
		return mktime(0,0,0,$month-1,1,$year);

}

function get_grade($userid, $course)
{
	global $DB;
	global $CFG;
	$logs = $DB->get_records_sql("SELECT l.id, l.statusid, l.statusset, s.description
							FROM {$CFG->prefix}attendance_log l
							JOIN {$CFG->prefix}attendance_sessions s
							  ON l.sessionid = s.id
						   WHERE l.studentid = $userid
						     AND s.courseid  = $course->id
						     AND s.sessdate >= $course->startdate");
	$result = 0;
	if ($logs) {
		$stat_grades = $DB->get_records_menu('attendance_statuses', array('courseid'=>$course->id), 'id', 'id, grade');
		foreach ($logs as $log) {
            if($log->description=="1")
				$result += $stat_grades[$log->statusid];
            if($log->description=="2")
				$result += $stat_grades[$log->statusid];
            if($log->description=="3")
				$result += $stat_grades[$log->statusid];
			if($log->description == "4")
				$result += $stat_grades[$log->statusid]*1.5;
	if($log->description=="5")
			$result += $stat_grades[$log->statusid]*2;
			if($log->description == "6")
			$result += $stat_grades[$log->statusid]*3;
		}
		
		if(isset($course->attendance_margin)){
			$margin = $course->attendance_margin;
			while($margin > 0){
				if($log->description=="1")
				$result += 1;
	            if($log->description=="2")
					$result += 1;
	            if($log->description=="3")
					$result += 1;
				if($log->description == "4")
					$result += 1.5;
		if($log->description=="5")
				$result += 2;
				if($log->description == "6")
				$result += 3;
				$margin--;
			}
		}
	}
	
	return $result;
}

function get_grade_bydate($userid, $course,$where)
{
	global $CFG;
	global $DB;
	$logs = $DB->get_records_sql("SELECT l.id, l.statusid, l.statusset, s.description
							FROM {$CFG->prefix}attendance_log l
							JOIN {$CFG->prefix}attendance_sessions s
							  ON l.sessionid = s.id
						   WHERE l.studentid = $userid AND ".$where);
	$result = 0;
	if ($logs) {
		$stat_grades = $DB->get_records_menu('attendance_statuses', array('courseid'=>$course->id), 'id', 'id, grade');
		foreach ($logs as $log) {
            if($log->description=="1")
				$result += $stat_grades[$log->statusid];
            if($log->description=="2")
				$result += $stat_grades[$log->statusid];
            if($log->description=="3")
				$result += $stat_grades[$log->statusid];
	    if($log->description=="4")
				$result += $stat_grades[$log->statusid]*1.5;
	if($log->description=="5")
			$result += $stat_grades[$log->statusid]*2;
			if($log->description=="6")
			$result += $stat_grades[$log->statusid]*3;
	
		}
	}

	return $result;
}

//temporary solution, for support PHP 4.3.0 which minimal requirement for Moodle 1.9.x
function local_array_intersect_key($array1, $array2) {
    $result = array();
    foreach ($array1 as $key => $value) {
        if (isset($array2[$key])) {
            $result[$key] = $value;
        }
    }
    return $result;
}

function get_maxgrade($userid, $course)
{
	global $CFG, $DB;
	$logs = $DB->get_records_sql("SELECT l.id, l.statusid, l.statusset, s.description
							FROM {$CFG->prefix}attendance_log l
							JOIN {$CFG->prefix}attendance_sessions s
							  ON l.sessionid = s.id
						   WHERE l.studentid = $userid
						     AND s.courseid  = $course->id
						     AND s.sessdate >= $course->startdate");
	$maxgrade = 0;
	if ($logs) {
		$stat_grades = $DB->get_records_menu('attendance_statuses', array('courseid'=>$course->id), 'id', 'id, grade');
		foreach ($logs as $log) {
			$ids = array_flip(explode(',', $log->statusset));
//			$grades = array_intersect_key($stat_grades, $ids); // require PHP 5.1.0 and higher
			$grades = local_array_intersect_key($stat_grades, $ids); //temporary solution, for support PHP 4.3.0 which minimal requirement for Moodle 1.9.x
                        if($log->description=="1")
                            $maxgrade += max($grades);
                        if($log->description=="2")
                            $maxgrade += max($grades);
                        if($log->description=="3")
                            $maxgrade += max($grades);
                        if($log->description=="4")
                            $maxgrade += 1.5;
			if($log->description=="5")
			$maxgrade += 2;
			if($log->description=="6")
			$maxgrade += 3;
			
		}
		if(isset($course->attendance_margin)){
			$margin = $course->attendance_margin;
			while($margin > 0){
				if($log->description=="1")
				$maxgrade += 1;
	            if($log->description=="2")
					$maxgrade += 1;
	            if($log->description=="3")
					$maxgrade += 1;
				if($log->description == "4")
					$maxgrade += 1.5;
		if($log->description=="5")
				$maxgrade += 2;
				if($log->description == "6")
				$maxgrade += 3;
				$margin--;
			}
		}
	}
	
	return $maxgrade;
}

function get_maxgrade_bydate($userid, $course,$where)
{
	global $CFG;
	global $DB;
        $qry = "SELECT l.id, l.statusid, l.statusset, s.description
							FROM {$CFG->prefix}attendance_log l
							JOIN {$CFG->prefix}attendance_sessions s
							  ON l.sessionid = s.id
						   WHERE l.studentid = $userid AND ".$where;
	$logs = $DB->get_records_sql($qry);
        //echo $qry.'<br>';
	$maxgrade = 0;
	if ($logs) {
		$stat_grades = $DB->get_records_menu('attendance_statuses', array('courseid'=>$course->id), 'id', 'id, grade');
		foreach ($logs as $log) {
			$ids = array_flip(explode(',', $log->statusset));
			//$grades = array_intersect_key($stat_grades, $ids); // require PHP 5.1.0 and higher
			$grades = local_array_intersect_key($stat_grades, $ids); //temporary solution, for support PHP 4.3.0 which minimal requirement for Moodle 1.9.x

			if($log->description=="1")
				$maxgrade += max($grades);
			if($log->description=="2")
				$maxgrade += max($grades);
			if($log->description=="3")
				$maxgrade += max($grades);
			if($log->description=="4")
				$maxgrade += 1.5;
			if($log->description=="5")
			$maxgrade += 2;
			if($log->description=="6")
			$maxgrade += 3;
		}
	}
        //echo $qry."<br>";
	return $maxgrade;
}

function get_percent_adaptive($userid, $course) // NOT USED
{
	global $CFG;
	global $DB;
	$logs = get_records_sql("SELECT l.id, l.statusid, l.statusset
							FROM {$CFG->prefix}attendance_log l
							JOIN {$CFG->prefix}attendance_sessions s
							  ON l.sessionid = s.id
						   WHERE l.studentid = $userid
						     AND s.courseid  = $course->id
						     AND s.sessdate >= $course->startdate");
	$result = 0;
	if ($logs) {
		$stat_grades = $DB->get_records_menu('attendance_statuses', array('courseid'=>$course->id), 'id', 'grade');
		
		$percent = 0;
		foreach ($logs as $log) {
			$ids = array_flip(explode(',', $log->statusset));
			$grades = array_intersect_key($stat_grades, $ids);
			$delta = max($grades) - min($grades);
			$percent += $stat_grades[$log->statusid] / $delta;
		}
		$result = $percent / count($logs) * 100;
	}
	if (!$dp = grade_get_setting($course->id, 'decimalpoints')) {
		$dp = $CFG->grade_decimalpoints;
	}
	
	return sprintf("%0.{$dp}f", $result);
}

function get_percent($userid, $course,$where='')
{
    global $CFG;
    if($where==''){
        $maxgrd = get_maxgrade($userid, $course);
    }
    else{
        $maxgrd = get_maxgrade_bydate($userid, $course,$where);
    }
    if ($maxgrd == 0) {
    	$result = 0;
    } else {
        if($where==''){
            $result = get_grade($userid, $course) / $maxgrd * 100;
        }
        else{
            $result = get_grade_bydate($userid, $course,$where) / $maxgrd * 100;

        }
    	
    }
    if ($result < 0) {
        $result = 0;
    }
	if (!$dp = grade_get_setting($course->id, 'decimalpoints')) {
		$dp = $CFG->grade_decimalpoints;
	}

	return sprintf("%0.{$dp}f", $result);
}

function get_percent_absent($userid, $course, $where='')
{
    global $CFG;

    if($where==''){
        $maxgrd = get_maxgrade($userid, $course);
    }
    else{
        $maxgrd = get_maxgrade_bydate($userid, $course,$where);
    }
    if ($maxgrd == 0) {
    	$result = 0;
    } else {
    	if($where==''){
            $result = get_grade($userid, $course) / $maxgrd * 100;
        }
        else{
            $result = get_grade_bydate($userid, $course,$where) / $maxgrd * 100;

        }
    }
    if ($result < 0) {
        $result = 0;
    }
    if (!$dp = grade_get_setting($course->id, 'decimalpoints')) {
            $dp = $CFG->grade_decimalpoints;
    }

    return sprintf("%0.{$dp}f", 100-$result);
}

function set_current_view($courseid, $view) {
    global $SESSION;

    return $SESSION->currentattview[$courseid] = $view;
}

function get_current_view($courseid) {
    global $SESSION;

    if (isset($SESSION->currentattview[$courseid]))
        return $SESSION->currentattview[$courseid];
    else
        return 'all';
}

function print_row($left, $right) {
    echo "\n<tr><td nowrap=\"nowrap\" align=\"right\" valign=\"top\" class=\"cell c0\">$left</td><td align=\"left\" valign=\"top\" class=\"info c1\">$right</td></tr>\n";
}

function print_attendance_table($user,  $course) {

	$complete = get_attendance($user->id, $course);
	$percent = get_percent($user->id, $course).'&nbsp;%';
	$grade = get_grade($user->id, $course);
	
    echo '<table border="0" cellpadding="0" cellspacing="0" class="list">';
    print_row(get_string('sessionscompleted','attforblock').':', "<strong>$complete</strong>");
    $statuses = get_statuses($course->id);
	foreach($statuses as $st) {
		print_row($st->description.': ', '<strong>'.get_attendance($user->id, $course, $st->id).'</strong>');
	}
    print_row(get_string('attendancepercent','attforblock').':', "<strong>$percent</strong>");
    print_row(get_string('attendancegrade','attforblock').':', "<strong>$grade</strong> / ".get_maxgrade($user->id, $course));
    print_row('&nbsp;', '&nbsp;');
  	echo '</table>';
	
}

function print_user_attendaces($user, $cm,  $course = 0, $printing = null) {
	global $CFG, $COURSE, $mode;
	global $OUTPUT, $DB;
	echo '<table class="userinfobox">';
    if (!$printing) {
		echo '<tr>';
	    echo '<td colspan="2" class="generalboxcontent"><div align="right">';
	    echo $OUTPUT->help_icon('studentview', 'attforblock', get_string('attendancereport','attforblock'));
	    echo "<a href=\"view.php?id={$cm->id}&amp;student={$user->id}&amp;mode=$mode&amp;printing=yes\" target=\"_blank\">[".get_string('versionforprinting','attforblock').']</a></div></td>';
	    echo '</tr>';
    }
//    echo '<tr>';
//    echo '<th colspan="2"><h2 class="main help"><center>'.get_string('attendancereport','attforblock').helpbutton('studentview', get_string('attendancereport','attforblock'), 'attforblock', true, false, '', true).'</center></h1></th>';
//    echo '</tr>';
    echo '<tr>';
    echo '<td class="left side">';
    echo $OUTPUT->user_picture($user, array($COURSE->id));
    echo '</td>';
    echo '<td class="generalboxcontent">';
    echo '<font size="+1"><b>'.'<a href="../../user/view.php?id='.$user->id.'">'.fullname($user).'</a></b></font>';
	if ($course) {
		echo '<hr />';
		$complete = get_attendance($user->id, $course);
		if($complete) {
			print_attendance_table($user,  $course);
		} else {
			echo get_string('attendancenotstarted','attforblock');
		}
	} else {
		$stqry = "SELECT ats.id,ats.courseid 
					FROM {$CFG->prefix}attendance_log al 
					JOIN {$CFG->prefix}attendance_sessions ats 
					  ON al.sessionid = ats.id
				   WHERE al.studentid = {$user->id}
				GROUP BY ats.courseid
				ORDER BY ats.courseid asc";
		$recs = $DB->get_records_sql_menu($stqry);
		foreach ($recs as $id => $courseid) {
			echo '<hr />';
			echo '<table border="0" cellpadding="0" cellspacing="0" width="100%" class="list1">';
			$nextcourse = $DB->get_record('course', array('id'=>$courseid));
			echo '<tr><td valign="top"><strong>'.$nextcourse->fullname.'</strong></td>';
			echo '<td align="right">';
			$complete = get_attendance($user->id, $nextcourse);
			if($complete) {
				print_attendance_table($user,  $nextcourse);
			} else {
				echo get_string('attendancenotstarted','attforblock');
			}
			echo '</td></tr>';
			echo '</table>';
		}
	}

	
	if ($course) {
		$stqry = "SELECT ats.sessdate,ats.description,ats.topicname,al.statusid,al.remarks 
					FROM {$CFG->prefix}attendance_log al 
					JOIN {$CFG->prefix}attendance_sessions ats 
					  ON al.sessionid = ats.id
				   WHERE ats.courseid = {$course->id} AND al.studentid = {$user->id} 
				ORDER BY ats.sessdate asc";
		if ($sessions = $DB->get_records_sql($stqry)) {
	     	$statuses = get_statuses($course->id);
	     	?>
			<div id="mod-assignment-submissions">
			<table align="left" cellpadding="3" cellspacing="0" class="submissions">
			  <tr>
				<th>#</th>
				<th align="center"><?php print_string('date')?></th>
				<th align="center"><?php print_string('time')?></th>
				<th align="center"><?php print_string('description','attforblock')?></th>
				<th align="center"><?php print_string('status','attforblock')?></th>
				<th align="center"><?php print_string('remarks','attforblock')?></th>
			  </tr>
			  <?php 
		  	$i = 1;
			foreach($sessions as $key=>$session)
			{
			  ?>
			  <tr>
				<td align="center"><?php echo $i++;?></td>
				<td><?php echo userdate($session->sessdate, get_string('strftimedmyw', 'attforblock')); //userdate($students->sessdate,'%d.%m.%y&nbsp;(%a)', 99, false);?></td>
				<td><?php echo userdate($session->sessdate, get_string('strftimehm', 'attforblock')); ?></td>
				<td><?php echo  (get_description($session->description) ?  (get_description($session->description)) :  (get_description($session->description)))."(".$session->topicname.")";  ?></td>
				<td><?php echo $statuses[$session->statusid]->description ?></td>
				<td><?php echo $session->remarks;?></td>
			  </tr>
			  <?php
	  		}
	  		echo '</table>';
		} else {
			echo $OUTPUT->heading(get_string('noattforuser','attforblock'));
		}
	}
	echo '</td></tr><tr><td>&nbsp;</td></tr></table></div>';
}

function get_description($description, $report = null){
    if($report){
    	switch ($description){
    		case "1":
    			return "Class";
    			break;
    		case "2":
    			return "2H-Lab";
    			break;
    		case "3":
    			return "3H-Lab";
    			break;
    		case "4":
    			return "90M-Class";
    			break;
		case "5":
				return "2H-Class";
				break;
			case "6":
				return "3H-Class";
				break;
    	}
    }else{
        if($description == "1"){
            return get_string('normalclass1','attforblock');
        }elseif($description == "2"){
            return get_string('twohourslab1','attforblock');
        }elseif($description == "3"){
            return get_string('threehourslab1','attforblock');
        }elseif($description == "4"){
            return get_string('ninety_minsclass1','attforblock');
        }elseif($description == "5"){
			return get_string('twohoursclass','attforblock');
		}elseif($description == "6"){
			return get_string('threehoursclass','attforblock');
		}else{
            return $description;
        }
    }

}
?> 
	

